<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Job API Monitor Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #0b1220; color: #e7eefc; }
    .card { background: #111a2e; border: 1px solid #1f2a44; border-radius: 12px; padding: 16px; max-width: 820px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; }
    .box { flex: 1; min-width: 160px; background: #0f1830; border: 1px solid #1f2a44; border-radius: 12px; padding: 12px; }
    .status { font-weight: 700; padding: 6px 10px; border-radius: 999px; display: inline-block; }
    .up { background: rgba(0,200,120,.15); border: 1px solid rgba(0,200,120,.45); }
    .down { background: rgba(255,80,80,.15); border: 1px solid rgba(255,80,80,.45); }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { padding: 10px; border-bottom: 1px solid #1f2a44; text-align: left; font-size: 14px; }
    .muted { color: #9db0d1; }
    a { color: #8ab4ff; }
    code { background: #0f1830; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Job API Monitor Dashboard</h1>
  <p class="muted">Powered by GitHub Actions + Public Job API</p>

  <div class="card">
    <div>
      <div id="statusBadge" class="status">Loading…</div>
      <div class="muted" style="margin-top:8px">
        API: <a id="apiLink" href="#" target="_blank" rel="noreferrer">—</a>
      </div>
    </div>

    <div class="row">
      <div class="box">
        <div class="muted">Last Checked (UTC)</div>
        <div id="lastChecked" style="font-size:18px; margin-top:6px;">—</div>
      </div>
      <div class="box">
        <div class="muted">HTTP Code</div>
        <div id="httpCode" style="font-size:18px; margin-top:6px;">—</div>
      </div>
      <div class="box">
        <div class="muted">Latency</div>
        <div id="latency" style="font-size:18px; margin-top:6px;">—</div>
      </div>
      <div class="box">
        <div class="muted">Jobs Count</div>
        <div id="jobsCount" style="font-size:18px; margin-top:6px;">—</div>
      </div>
    </div>

    <h3 style="margin-top:18px;">Recent History</h3>
    <div class="muted">Latest 10 checks from <code>history.csv</code></div>
    <table id="historyTable">
      <thead>
        <tr>
          <th>Time (UTC)</th>
          <th>Status</th>
          <th>HTTP</th>
          <th>Latency (ms)</th>
          <th>Jobs</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="muted" style="margin-top:12px;">
      If the API fails, the status will show DOWN and error will be recorded in logs.
    </div>
  </div>

<script>
async function loadStatus() {
  const res = await fetch('./status.json', { cache: 'no-store' });
  if (!res.ok) throw new Error('status.json not found yet');
  return await res.json();
}

async function loadHistory() {
  const res = await fetch('./history.csv', { cache: 'no-store' });
  if (!res.ok) throw new Error('history.csv not found yet');
  return await res.text();
}

function setBadge(status) {
  const el = document.getElementById('statusBadge');
  el.textContent = status;
  el.classList.remove('up','down');
  el.classList.add(status === 'UP' ? 'up' : 'down');
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const header = lines[0].split(',');
  return lines.slice(1).map(line => {
    const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/); // basic CSV split
    const obj = {};
    header.forEach((h,i)=> obj[h] = (cols[i]||'').replace(/^"|"$/g,''));
    return obj;
  });
}

(async () => {
  try {
    const s = await loadStatus();
    setBadge(s.status || 'DOWN');
    document.getElementById('apiLink').textContent = s.api_url || '—';
    document.getElementById('apiLink').href = s.api_url || '#';
    document.getElementById('lastChecked').textContent = (s.timestamp_utc || '—');
    document.getElementById('httpCode').textContent = (s.http_code || '—');
    document.getElementById('latency').textContent = (s.latency_ms ?? '—');
    document.getElementById('jobsCount').textContent = (s.jobs_count ?? '—');
  } catch (e) {
    setBadge('DOWN');
    document.getElementById('lastChecked').textContent = 'Waiting for first run…';
  }

  try {
    const csv = await loadHistory();
    const rows = parseCSV(csv).slice(-10).reverse();
    const tbody = document.querySelector('#historyTable tbody');
    tbody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.timestamp_utc || ''}</td>
        <td>${r.status || ''}</td>
        <td>${r.http_code || ''}</td>
        <td>${r.latency_ms || ''}</td>
        <td>${r.jobs_count || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (e) {
    // ignore if no file yet
  }
})();
</script>
</body>
</html>
